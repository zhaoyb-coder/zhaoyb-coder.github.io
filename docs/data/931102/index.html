<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mysql锁-技术分析 | 赵宇博的技术博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="沉淀，静待花开">
    
    <link rel="preload" href="/assets/css/0.styles.2eb69015.css" as="style"><link rel="preload" href="/assets/js/app.3cea95fd.js" as="script"><link rel="preload" href="/assets/js/2.75aeda74.js" as="script"><link rel="preload" href="/assets/js/28.53aaf34b.js" as="script"><link rel="prefetch" href="/assets/js/10.f2a5cc23.js"><link rel="prefetch" href="/assets/js/11.c252a926.js"><link rel="prefetch" href="/assets/js/12.cfabdd67.js"><link rel="prefetch" href="/assets/js/13.edd887e6.js"><link rel="prefetch" href="/assets/js/14.0255c1d1.js"><link rel="prefetch" href="/assets/js/15.04f46e52.js"><link rel="prefetch" href="/assets/js/16.5e2601c1.js"><link rel="prefetch" href="/assets/js/17.aca69f3f.js"><link rel="prefetch" href="/assets/js/18.ceb081b0.js"><link rel="prefetch" href="/assets/js/19.95dc2813.js"><link rel="prefetch" href="/assets/js/20.8a02dbc5.js"><link rel="prefetch" href="/assets/js/21.60ae8121.js"><link rel="prefetch" href="/assets/js/22.5946d660.js"><link rel="prefetch" href="/assets/js/23.ec49ecc7.js"><link rel="prefetch" href="/assets/js/24.dee7c70f.js"><link rel="prefetch" href="/assets/js/25.2f4d07dc.js"><link rel="prefetch" href="/assets/js/26.f7852929.js"><link rel="prefetch" href="/assets/js/27.a127166a.js"><link rel="prefetch" href="/assets/js/29.4b9b3e95.js"><link rel="prefetch" href="/assets/js/3.f72bdc03.js"><link rel="prefetch" href="/assets/js/30.34d04e01.js"><link rel="prefetch" href="/assets/js/31.d5b03dcb.js"><link rel="prefetch" href="/assets/js/4.24c9ae9d.js"><link rel="prefetch" href="/assets/js/5.6d25220f.js"><link rel="prefetch" href="/assets/js/6.8f03b34d.js"><link rel="prefetch" href="/assets/js/7.2d204911.js"><link rel="prefetch" href="/assets/js/8.84de57bc.js"><link rel="prefetch" href="/assets/js/9.35ac9493.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2eb69015.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="赵宇博的技术博客" class="logo"> <span class="site-name can-hide">赵宇博的技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/fe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/be/" class="nav-link">后端</a></div><div class="nav-item"><a href="/data/" class="nav-link router-link-active">数据库专栏</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">k8s专栏</a></div><div class="nav-item"><a href="/dcs/" class="nav-link">分布式专栏</a></div><div class="nav-item"><a href="/more/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/zhaoyb-coder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/fe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/be/" class="nav-link">后端</a></div><div class="nav-item"><a href="/data/" class="nav-link router-link-active">数据库专栏</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">k8s专栏</a></div><div class="nav-item"><a href="/dcs/" class="nav-link">分布式专栏</a></div><div class="nav-item"><a href="/more/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/zhaoyb-coder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Mysql总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data/931102/" aria-current="page" class="active sidebar-link">Mysql锁-技术分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/data/931102/#_1、共享锁和排它锁" class="sidebar-link">1、共享锁和排它锁</a></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_2、意向锁" class="sidebar-link">2、意向锁</a></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_3、记录锁" class="sidebar-link">3、记录锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/data/931102/#_3-1、无索引更新-锁表场景" class="sidebar-link">3.1、无索引更新-锁表场景</a></li><li class="sidebar-sub-header level3"><a href="/data/931102/#_3-2、有索引更新-锁固定行场景" class="sidebar-link">3.2、有索引更新-锁固定行场景</a></li><li class="sidebar-sub-header level3"><a href="/data/931102/#_3-3、类型错误-导致索引失效锁表场景" class="sidebar-link">3.3、类型错误-导致索引失效锁表场景</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_4、间隙锁" class="sidebar-link">4、间隙锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/data/931102/#_4-1、where-id-7-情况展示" class="sidebar-link">4.1、where id &gt; 7 情况展示</a></li><li class="sidebar-sub-header level3"><a href="/data/931102/#_4-2、where-id-7-and-id-23-情况展示" class="sidebar-link">4.2、where id &gt; 7 and id &lt; 23 情况展示</a></li><li class="sidebar-sub-header level3"><a href="/data/931102/#_4-3、where-id-7-情况展示" class="sidebar-link">4.3、where id = 7 情况展示</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_5、临键锁" class="sidebar-link">5、临键锁</a></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_6、页锁" class="sidebar-link">6、页锁</a></li><li class="sidebar-sub-header level2"><a href="/data/931102/#_7、死锁" class="sidebar-link">7、死锁</a></li></ul></li><li><a href="/data/2f28ce/" class="sidebar-link">Mysql-日志详解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES总结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/data/#数据库专栏" data-v-06225672>数据库专栏</a></li><li data-v-06225672><a href="/data/#Mysql总结" data-v-06225672>Mysql总结</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/zhaoyb-coder" target="_blank" title="作者" class="beLink" data-v-06225672>zhaoyb</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-12-05</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Mysql锁-技术分析<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="mysql锁-技术分析"><a href="#mysql锁-技术分析" class="header-anchor">#</a> Mysql锁-技术分析</h1> <p>本文所有的分析都是基于Innodb存储引擎，对于经常听说的<code>共享锁、排它锁、记录锁、间隙锁、临键锁、意向锁</code>进行详细的解释和演练展示（Mysql8.0版本）</p> <blockquote><p>关于锁：</p> <p>锁都是基于索引去找到数据记录再加锁的，而索引的规则是：通过其它索引找到主键索引，所以数据表如果没有索引，那么做更新等操作会进行锁表；如果通过主键或者唯一索引进行加锁，只会锁具体的行（也就是记录锁），如果是非唯一索引，SQL优化器会根据数据分布自动选择记录锁或者临键锁</p></blockquote> <h2 id="_1、共享锁和排它锁"><a href="#_1、共享锁和排它锁" class="header-anchor">#</a> 1、共享锁和排它锁</h2> <p>共享锁(Shared Lock)又被称之为<code>读锁</code>、<code>S锁</code>，当前数据被某个事务获取了共享锁之后，还可以被其它事务获取共享锁，但是不能被其它事务获取排它锁</p> <p>排它锁（exclusive Lock)又被称之为<code>写锁</code>、<code>X锁</code>，当前数据被某个事务获取了排它锁之后，不可以被其它事务获取排它锁，也不能被其它事务获取共享锁</p> <p>默认Select操作是不加锁的，更新、增加、删除操作会自动加入排它锁</p> <p>也可以使用关键字强制为Select操作增加共享锁和排它锁（<code>不推荐</code>）</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 共享锁 lock in share mode 或者 for share</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">where</span> id <span class="token operator">=</span> xx <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">where</span> id <span class="token operator">=</span> xx <span class="token keyword">for</span> <span class="token keyword">share</span><span class="token punctuation">;</span>
<span class="token comment">-- 排它锁 for update</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">where</span> id <span class="token operator">=</span> xx <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>演练展示：</p> <p>共享锁展示</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206130429579.png" alt="image-20231206130429579"></p> <p>排它锁展示</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206130638934.png" alt="image-20231206130638934"></p> <h2 id="_2、意向锁"><a href="#_2、意向锁" class="header-anchor">#</a> 2、意向锁</h2> <p>Mysql的意向锁分为意向共享锁（Intention Shared Lock，IS）、意向排它锁（Intention Exclusive, IX）</p> <ul><li>作用范围：表级别的锁，用于表示事务将要在这个表的某个部分设置共享或者排它锁</li> <li>阻塞情况：意向锁通常不会导致实际的锁定，而是用于表明事务的意向</li></ul> <p>意向锁的引入主要是为了在表级别和行级别提供更大的并发性，允许多个事务在不冲突的情况下，同时操作数据库。<code>这些意向锁不是直接由用户请求的，而是Mysql自动管理的</code>用于确保多个事务同时进行时，它们之间的锁不会相互冲突。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 设置意向共享锁</span>
<span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span> <span class="token keyword">table</span> <span class="token keyword">READ</span><span class="token punctuation">;</span>
<span class="token comment">-- 设置意向排它锁</span>
<span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span> <span class="token keyword">table</span> <span class="token keyword">WRITE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>注意：事务提交只会自动释放行级锁，不会自动释放表级锁，这是因为行级锁是在事务内部管理的，而表级锁可能会跨越事务。所以，如果有表级锁的情况，必须在适当的时候执行<code>UNLOCK TABLES;</code>进行表级锁的释放</strong></p> <hr> <p>共享锁（S）、排他锁（X）、意向共享锁（IS）、意向排他锁（IX）的兼容关系</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">S</th> <th style="text-align:center;">X</th> <th style="text-align:center;">IS</th> <th style="text-align:center;">IX</th></tr></thead> <tbody><tr><td style="text-align:center;">S</td> <td style="text-align:center;"><strong>√</strong></td> <td style="text-align:center;">×</td> <td style="text-align:center;"><strong>√</strong></td> <td style="text-align:center;">×</td></tr> <tr><td style="text-align:center;">X</td> <td style="text-align:center;"><strong>×</strong></td> <td style="text-align:center;">×</td> <td style="text-align:center;">×</td> <td style="text-align:center;">×</td></tr> <tr><td style="text-align:center;">IS</td> <td style="text-align:center;"><strong>√</strong></td> <td style="text-align:center;">×</td> <td style="text-align:center;"><strong>√</strong></td> <td style="text-align:center;">×</td></tr> <tr><td style="text-align:center;">IX</td> <td style="text-align:center;">×</td> <td style="text-align:center;">×</td> <td style="text-align:center;">×</td> <td style="text-align:center;">×</td></tr></tbody></table> <p>演练展示：</p> <p>意向共享锁（IS）不兼容 意向排他锁（IX）</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206135835532.png" alt="image-20231206135835532"></p> <h2 id="_3、记录锁"><a href="#_3、记录锁" class="header-anchor">#</a> 3、记录锁</h2> <blockquote><p>记录锁是一个锁的概念，是一种锁定机制，并不是真是存在的某一类锁</p> <p>记录锁分为共享锁（Shared Lock）和排他锁（Exclusive Lock）</p></blockquote> <p>前置条件：</p> <p>数据表t_test，ID主键索引，name唯一索引，age普通索引，city无索引</p> <h3 id="_3-1、无索引更新-锁表场景"><a href="#_3-1、无索引更新-锁表场景" class="header-anchor">#</a> 3.1、无索引更新-锁表场景</h3> <p>事务2以city为条件进行加排它锁，但是city没有索引，导致事务2锁表</p> <p>事务1以id=3为条件获取共享锁，因为事务2锁了整个表，导致等待</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206144538583.png" alt="image-20231206144538583"></p> <h3 id="_3-2、有索引更新-锁固定行场景"><a href="#_3-2、有索引更新-锁固定行场景" class="header-anchor">#</a> 3.2、有索引更新-锁固定行场景</h3> <p>事务2通过age=20的索引找到主键索引2,3两条数据，进行记录锁（排它锁）</p> <p>事务1通过主键id=6设置记录锁（排它锁）</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206150202945.png" alt="image-20231206150202945"></p> <h3 id="_3-3、类型错误-导致索引失效锁表场景"><a href="#_3-3、类型错误-导致索引失效锁表场景" class="header-anchor">#</a> 3.3、类型错误-导致索引失效锁表场景</h3> <p>id字段设置的类型是varchar，但是查询的时候使用id=1进行查询，导致数据类型不一致，索引失效，最终导致锁表，所以事务2再进行id = '6'的加锁时导致等待。</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206150440330.png" alt="image-20231206150440330"></p> <h2 id="_4、间隙锁"><a href="#_4、间隙锁" class="header-anchor">#</a> 4、间隙锁</h2> <blockquote><p>间隙锁用于锁定一定范围内键之间的间隙，而不是具体的记录。</p> <p>间隙锁的目的是为了防止并发事务插入新的键值，从而确保事务之间的一致性</p></blockquote> <p>间隙锁的机制是为了解决幻读的问题，通过使用间隙锁，可以确保在一个事务中的查询操作所涉及的键范围内不会发生插入新记录的情况。如果操作的数据跨多个范围，就是加多个区域的间隙锁(<code>左开右闭</code>的区间)</p> <p>举例：（<code>RR隔离级别下</code>）</p> <p>假如我们的数据表中存在id=5、10、20、25、30这五条数据</p> <ul><li>查询where id &gt; 7 for update;那**<code>锁住的数据范围就是5到正无穷大（5，+∞]，是以5开始的，并不是7开始，因为数据库中并没有id=7的数据</code>**，另一个事务就无法插入id=6的数据</li> <li>查询where id &gt; 7 and id &lt; 23,那锁住的区间就是(5,10]、(10,20]、(20,25],也就是说5-25之间的所有数据都不能插入</li> <li>查询 where id = 7,因为id=7的数据不存在，锁住的也是一个最近的区间(5,10]</li></ul> <h3 id="_4-1、where-id-7-情况展示"><a href="#_4-1、where-id-7-情况展示" class="header-anchor">#</a> 4.1、where id &gt; 7 情况展示</h3> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206153113285.png" alt="image-20231206153113285"></p> <h3 id="_4-2、where-id-7-and-id-23-情况展示"><a href="#_4-2、where-id-7-and-id-23-情况展示" class="header-anchor">#</a> 4.2、where id &gt; 7 and id &lt; 23 情况展示</h3> <p>id=18的数据无法插入</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206153336202.png" alt="image-20231206153336202"></p> <p>id=24的数据无法插入</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206153435683.png" alt="image-20231206153435683"></p> <h3 id="_4-3、where-id-7-情况展示"><a href="#_4-3、where-id-7-情况展示" class="header-anchor">#</a> 4.3、where id = 7 情况展示</h3> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231206153636094.png" alt="image-20231206153636094"></p> <hr> <p><code>注意：基于唯一索引或者主键索引，此时的间隙锁比较容易理解，但是基于非唯一索引的情况，SQL最终的执行的结果是由优化器决定的（有可能和索引有关，有可能和数据总量有关）</code></p> <h2 id="_5、临键锁"><a href="#_5、临键锁" class="header-anchor">#</a> 5、临键锁</h2> <blockquote><p>临键锁（Next-Key Lock）是一种特殊的锁定机制，结合了行锁和间隙锁的特性，用于提供更强的隔离性，以防止幻读和其他并发问题</p></blockquote> <p>简单来说，临键锁 = 间隙锁 + 记录锁。临键锁的工作方式是通过在查询的每一行上设置行锁，并且在每两个相邻键之间设置间隙锁，来确保事务一致性和隔离性</p> <p><strong><code>MySQL默认的锁就是临键锁，所以在执行SQL的时候，记录锁和间隙锁是会同时存在的。范围是左开右闭的区间</code></strong></p> <h2 id="_6、页锁"><a href="#_6、页锁" class="header-anchor">#</a> 6、页锁</h2> <blockquote><p>页锁（Page-Level Locking）是一种锁定机制，允许数据库在表的页级别上实施锁定，以确保在并发访问时的数据一致性和隔离性。在 MySQL 中，页锁是一种相对较低级别的锁，介于行级锁和表级锁之间</p></blockquote> <p>页锁锁定表中的页面（Page页），每个页面包含多个行，可以减少锁定的开销</p> <p>默认的Innodb引擎支持行级表，而不是页锁，因为Innodb使用了更精细的多版本控制MVCC机制，可以在行级别实现高度的并发性。</p> <h2 id="_7、死锁"><a href="#_7、死锁" class="header-anchor">#</a> 7、死锁</h2> <ul><li><p>检测死锁的语句</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行上述语句后，查找输出中的 &quot;LATEST DETECTED DEADLOCK&quot; 部分，其中包含有关最近检测到的死锁的详细信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>检测哪些表被锁定</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">OPEN</span> <span class="token keyword">TABLES</span> <span class="token keyword">FROM</span> your_database_name <span class="token keyword">WHERE</span> In_use <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>显示当前执行的所有进程和其详细信息</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 锁定的表将在 State 列中显示相关信息</span>
<span class="token keyword">SHOW</span> <span class="token keyword">FULL</span> PROCESSLIST<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E9%94%81" title="标签">#锁</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/12/06, 16:06:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/data/2f28ce/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Mysql-日志详解</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/data/2f28ce/">Mysql-日志详解</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/data/932202/"><div>
            Redis-概述
            <!----></div></a> <span class="date">01-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/be/125102/"><div>
            JMM（Java内存模型）
            <!----></div></a> <span class="date">12-29</span></dt></dl><dl><dd>03</dd> <dt><a href="/be/935102/"><div>
            JVM概述
            <!----></div></a> <span class="date">12-25</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2024
    <span>赵宇博 | <a href="https://github.com/zhaoyb-coder/" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3cea95fd.js" defer></script><script src="/assets/js/2.75aeda74.js" defer></script><script src="/assets/js/28.53aaf34b.js" defer></script>
  </body>
</html>
