<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Activiti6-业务实现 | 赵宇博的技术博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="沉淀，静待花开">
    
    <link rel="preload" href="/assets/css/0.styles.42a2c9ab.css" as="style"><link rel="preload" href="/assets/js/app.e1cac8e6.js" as="script"><link rel="preload" href="/assets/js/2.1e4db32b.js" as="script"><link rel="preload" href="/assets/js/51.ad5c7c0a.js" as="script"><link rel="prefetch" href="/assets/js/10.7efe6867.js"><link rel="prefetch" href="/assets/js/11.8d285244.js"><link rel="prefetch" href="/assets/js/12.82731479.js"><link rel="prefetch" href="/assets/js/13.ed0802d4.js"><link rel="prefetch" href="/assets/js/14.98182ddd.js"><link rel="prefetch" href="/assets/js/15.c984db9b.js"><link rel="prefetch" href="/assets/js/16.093ae0c0.js"><link rel="prefetch" href="/assets/js/17.ce529c5c.js"><link rel="prefetch" href="/assets/js/18.2c15a004.js"><link rel="prefetch" href="/assets/js/19.73b23a14.js"><link rel="prefetch" href="/assets/js/20.7523a2df.js"><link rel="prefetch" href="/assets/js/21.49151248.js"><link rel="prefetch" href="/assets/js/22.ffeb1ccb.js"><link rel="prefetch" href="/assets/js/23.35c7a608.js"><link rel="prefetch" href="/assets/js/24.885251ad.js"><link rel="prefetch" href="/assets/js/25.c6e546e3.js"><link rel="prefetch" href="/assets/js/26.20f05943.js"><link rel="prefetch" href="/assets/js/27.31bb323b.js"><link rel="prefetch" href="/assets/js/28.9f795e29.js"><link rel="prefetch" href="/assets/js/29.c6ca9ffc.js"><link rel="prefetch" href="/assets/js/3.c8f649d0.js"><link rel="prefetch" href="/assets/js/30.5bbe2551.js"><link rel="prefetch" href="/assets/js/31.57ab7c88.js"><link rel="prefetch" href="/assets/js/32.9182738e.js"><link rel="prefetch" href="/assets/js/33.96397894.js"><link rel="prefetch" href="/assets/js/34.c26055a1.js"><link rel="prefetch" href="/assets/js/35.87428ea5.js"><link rel="prefetch" href="/assets/js/36.d61d6964.js"><link rel="prefetch" href="/assets/js/37.4fc0770e.js"><link rel="prefetch" href="/assets/js/38.ba7dbc6d.js"><link rel="prefetch" href="/assets/js/39.131015e3.js"><link rel="prefetch" href="/assets/js/4.beb55bf3.js"><link rel="prefetch" href="/assets/js/40.b3f95375.js"><link rel="prefetch" href="/assets/js/41.29653fc1.js"><link rel="prefetch" href="/assets/js/42.c670b19e.js"><link rel="prefetch" href="/assets/js/43.c6ee8462.js"><link rel="prefetch" href="/assets/js/44.cb4fc067.js"><link rel="prefetch" href="/assets/js/45.5791944b.js"><link rel="prefetch" href="/assets/js/46.64b92c8a.js"><link rel="prefetch" href="/assets/js/47.f58fc03e.js"><link rel="prefetch" href="/assets/js/48.26e810e5.js"><link rel="prefetch" href="/assets/js/49.40a6ecc5.js"><link rel="prefetch" href="/assets/js/5.d78e4b01.js"><link rel="prefetch" href="/assets/js/50.ba8c46ca.js"><link rel="prefetch" href="/assets/js/52.50fd105b.js"><link rel="prefetch" href="/assets/js/53.2c18a998.js"><link rel="prefetch" href="/assets/js/54.40023573.js"><link rel="prefetch" href="/assets/js/55.228ba16b.js"><link rel="prefetch" href="/assets/js/56.6ea82b2a.js"><link rel="prefetch" href="/assets/js/57.b480c7fe.js"><link rel="prefetch" href="/assets/js/58.a2c7f8aa.js"><link rel="prefetch" href="/assets/js/59.0f638304.js"><link rel="prefetch" href="/assets/js/6.57f1d291.js"><link rel="prefetch" href="/assets/js/60.996badfc.js"><link rel="prefetch" href="/assets/js/61.0e269abd.js"><link rel="prefetch" href="/assets/js/62.2bef7e97.js"><link rel="prefetch" href="/assets/js/63.4ef5e83c.js"><link rel="prefetch" href="/assets/js/64.7fe1087e.js"><link rel="prefetch" href="/assets/js/65.10fe512d.js"><link rel="prefetch" href="/assets/js/7.f3302cb1.js"><link rel="prefetch" href="/assets/js/8.c85d1aba.js"><link rel="prefetch" href="/assets/js/9.5c768040.js">
    <link rel="stylesheet" href="/assets/css/0.styles.42a2c9ab.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="赵宇博的技术博客" class="logo"> <span class="site-name can-hide">赵宇博的技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/fe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/be/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/data/" class="nav-link">数据库专栏</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">k8s专栏</a></div><div class="nav-item"><a href="/dcs/" class="nav-link">分布式专栏</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux网络专栏</a></div><div class="nav-item"><a href="/self/" class="nav-link">手写系列专栏</a></div><div class="nav-item"><a href="/more/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/zhaoyb-coder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/fe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/be/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/data/" class="nav-link">数据库专栏</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">k8s专栏</a></div><div class="nav-item"><a href="/dcs/" class="nav-link">分布式专栏</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux网络专栏</a></div><div class="nav-item"><a href="/self/" class="nav-link">手写系列专栏</a></div><div class="nav-item"><a href="/more/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/zhaoyb-coder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>源码专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Activi6专题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/be/activiti-01/" class="sidebar-link">Activiti6-28张表关系梳理</a></li><li><a href="/be/activiti-02/" class="sidebar-link">SpringBoot集成Activiti和UI</a></li><li><a href="/be/activiti-03/" class="sidebar-link">Activiti6-API详解</a></li><li><a href="/be/activiti-04/" aria-current="page" class="active sidebar-link">Activiti6-业务实现</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂谈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/be/#后端" data-v-06225672>后端</a></li><li data-v-06225672><a href="/be/#Activi6专题" data-v-06225672>Activi6专题</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/zhaoyb-coder" target="_blank" title="作者" class="beLink" data-v-06225672>zhaoyb</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-12-06</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Activiti6-业务实现<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="activiti6-业务实现"><a href="#activiti6-业务实现" class="header-anchor">#</a> Activiti6-业务实现</h1> <p>针对于Activiti，如何实现复杂的业务，这里做一些本地化的实现</p> <h3 id="_1、资产申请流程"><a href="#_1、资产申请流程" class="header-anchor">#</a> 1、资产申请流程</h3> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241209165516592.png" alt="image-20241209165516592"></p> <p>整个流程结束之后，执行任务列表如下：</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241209165112229.png" alt="image-20241209165112229"></p> <h3 id="_2、错误事件流程"><a href="#_2、错误事件流程" class="header-anchor">#</a> 2、错误事件流程</h3> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241209164952973.png" alt="image-20241209164952973"></p> <p>整个流程结束之后，执行任务列表如下：</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241209165041261.png" alt="image-20241209165041261"></p> <h3 id="_3、动态分配办理人"><a href="#_3、动态分配办理人" class="header-anchor">#</a> 3、动态分配办理人</h3> <h4 id="_3-1、uel表达式动态分配"><a href="#_3-1、uel表达式动态分配" class="header-anchor">#</a> 3.1、UEL表达式动态分配</h4> <p>1、在任务节点的Assignee属性中配置表达式 ${taskUserManager.getUser()}</p> <p>2、在代码中定义Bean如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskUserManager</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;zhaoyubo&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>执行到当前节点就可以通过代码动态查询出当节点的办理人</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212145459981.png" alt="image-20241212145459981"></p> <h4 id="_3-2、监听器动态分配"><a href="#_3-2、监听器动态分配" class="header-anchor">#</a> 3.2、监听器动态分配</h4> <p>1、每个节点都配置任务监听器，当节点创建时会执行监听器的逻辑</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212151305046.png" alt="image-20241212151305046"></p> <p>2、监听器代码中，根据当前节点的ID判断应该把节点任务给某个办理人</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 用户任务监听器 -监听器会在任务创建时执行
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserTaskListener</span> <span class="token keyword">implements</span> <span class="token class-name">TaskListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">DelegateTask</span> delegateTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> taskDefinitionKey <span class="token operator">=</span> delegateTask<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;audit1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>taskDefinitionKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegateTask<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;audit2&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>taskDefinitionKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegateTask<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>执行结果如下：</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212150358514.png" alt="image-20241212150358514"></p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212151208808.png" alt="image-20241212151208808"></p> <h3 id="_4、并行网关验证"><a href="#_4、并行网关验证" class="header-anchor">#</a> 4、并行网关验证</h3> <p>主要验证一个问题：并行网关不关注外出的顺序流，即使外出顺序流上面设置的条件为false，也会顺利到达下一个节点</p> <p>新建一个模型，在并行网关的第一个顺序流上设置一个false的条件，验证是否可以进入【审核3】节点</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212162640103.png" alt="image-20241212162640103"></p> <p>验证结果是可以的：</p> <p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241212162741963.png" alt="image-20241212162741963"></p> <h3 id="_5、动态跳转实现"><a href="#_5、动态跳转实现" class="header-anchor">#</a> 5、动态跳转实现</h3> <p>使用场景：当前流程在【节点1】，需要后台自动跳转到【节点3】，使用代码实现:</p> <p>主要逻辑就是先获取当前流程实例</p> <p>然后获取流程模型，根据参数中的两个节点ID，从流程模型中获取两个节点</p> <p>然后删除当前节点的相关数据</p> <p>然后创建新的流程实例，把流程实例的当前节点设置为要跳转的节点</p> <p>然后把这个新的流程实例压入Operation等待Activiti调用，之后就成功跳转到目标节点</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>bpmn<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">BpmnModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>bpmn<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">FlowElement</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">ActivitiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">ActivitiIllegalArgumentException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">Command</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">CommandContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEntityManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ProcessDefinitionUtil</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 动态跳转
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicJumpCmd</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 流程实例ID
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> processInstanceId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 跳转起始节点
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> fromActivityId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 跳转目标节点
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> toActivityId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DynamicJumpCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> processInstanceId<span class="token punctuation">,</span> <span class="token class-name">String</span> fromActivityId<span class="token punctuation">,</span> <span class="token class-name">String</span> toActivityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processInstanceId <span class="token operator">=</span> processInstanceId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fromActivityId <span class="token operator">=</span> fromActivityId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>toActivityId <span class="token operator">=</span> toActivityId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// processInstanceId参数不能为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processInstanceId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiIllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Process instance id is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取执行实例管理类</span>
        <span class="token class-name">ExecutionEntityManager</span> executionEntityManager <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getExecutionEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取执行实例</span>
        <span class="token class-name">ExecutionEntity</span> execution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span><span class="token punctuation">)</span>executionEntityManager<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>execution <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span><span class="token string">&quot;Execution could not be found with id &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>execution<span class="token punctuation">.</span><span class="token function">isProcessInstanceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Execution is not a process instance type execution for id &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ExecutionEntity</span> activeExecutionEntity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取所有子执行实例</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionEntity</span><span class="token punctuation">&gt;</span></span> childExecutions <span class="token operator">=</span>
            executionEntityManager<span class="token punctuation">.</span><span class="token function">findChildExecutionsByProcessInstanceId</span><span class="token punctuation">(</span>execution<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionEntity</span> childExecution <span class="token operator">:</span> childExecutions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>childExecution<span class="token punctuation">.</span><span class="token function">getCurrentActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fromActivityId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                activeExecutionEntity <span class="token operator">=</span> childExecution<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activeExecutionEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span><span class="token string">&quot;Active execution could not be found with activity id &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fromActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取流程模型</span>
        <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> <span class="token class-name">ProcessDefinitionUtil</span><span class="token punctuation">.</span><span class="token function">getBpmnModel</span><span class="token punctuation">(</span>execution<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前节点</span>
        <span class="token class-name">FlowElement</span> fromActivityElement <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fromActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取目标节点</span>
        <span class="token class-name">FlowElement</span> toActivityElement <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>toActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验id为fromActivityId的节点是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromActivityElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Activity could not be found in process definition for id &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fromActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 校验id为toActivityId的节点是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toActivityElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Activity could not be found in process definition for id &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> deleteParentExecution <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutionEntity</span> parentExecution <span class="token operator">=</span> activeExecutionEntity<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 兼容子流程节点的场景</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fromActivityElement<span class="token punctuation">.</span><span class="token function">getSubProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>toActivityElement<span class="token punctuation">.</span><span class="token function">getSubProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>toActivityElement<span class="token punctuation">.</span><span class="token function">getSubProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentExecution<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            deleteParentExecution <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 删除当前节点所在的执行实例及相关数据</span>
        executionEntityManager<span class="token punctuation">.</span><span class="token function">deleteExecutionAndRelatedData</span><span class="token punctuation">(</span>activeExecutionEntity<span class="token punctuation">,</span>
            <span class="token string">&quot;Change activity to &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toActivityId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果是子流程节点，删除其所在的执行实例及相关数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deleteParentExecution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executionEntityManager<span class="token punctuation">.</span><span class="token function">deleteExecutionAndRelatedData</span><span class="token punctuation">(</span>parentExecution<span class="token punctuation">,</span>
                <span class="token string">&quot;Change activity to &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toActivityId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建当前流程实例的子执行实例</span>
        <span class="token class-name">ExecutionEntity</span> newChildExecution <span class="token operator">=</span> executionEntityManager<span class="token punctuation">.</span><span class="token function">createChildExecution</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置执行实例的当前活动节点为目标节点</span>
        newChildExecution<span class="token punctuation">.</span><span class="token function">setCurrentFlowElement</span><span class="token punctuation">(</span>toActivityElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向operations中压入继续流程的操作类</span>
        <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token function">getAgenda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">planContinueProcessOperation</span><span class="token punctuation">(</span>newChildExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">ManagementService</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicJumpService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">DynamicJumpService</span><span class="token punctuation">(</span><span class="token class-name">ManagementService</span> managementService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>managementService <span class="token operator">=</span> managementService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ManagementService</span> managementService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeJump</span><span class="token punctuation">(</span><span class="token class-name">String</span> processInstanceId<span class="token punctuation">,</span> <span class="token class-name">String</span> fromActivityId<span class="token punctuation">,</span> <span class="token class-name">String</span> toActivityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 实例化自定义跳转Command类</span>
        <span class="token class-name">DynamicJumpCmd</span> dynamicJumpCmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicJumpCmd</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">,</span> fromActivityId<span class="token punctuation">,</span> toActivityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过ManagementService管理服务执行自定义跳转Command类</span>
        managementService<span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>dynamicJumpCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 验证动态跳转</span>
        <span class="token class-name">DynamicJumpService</span> dynamicJumpService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicJumpService</span><span class="token punctuation">(</span>managementService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从节点1 跳转到节点3</span>
        dynamicJumpService<span class="token punctuation">.</span><span class="token function">executeJump</span><span class="token punctuation">(</span><span class="token string">&quot;195001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sid-7B87D2B7-147B-4119-9C61-5CECEEE40699&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;sid-D1F7B581-CA2F-4868-879E-6E5D178DD097&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241216150426456.png" alt="image-20241216150426456"></p> <h3 id="_6、任务撤回实现"><a href="#_6、任务撤回实现" class="header-anchor">#</a> 6、任务撤回实现</h3> <p>任务撤回的场景是：任务提交之后，下一节点的审核人<strong>尚未进行审核</strong>，则提交人可以撤回当前任务,实现如下：</p> <p>先获取一节点所有的任务列表</p> <p>然后判断后续任务有没有结束</p> <p>然后把当前节点设置为要撤回的目标节点，</p> <p>最后把新的执行实例压入Operation等待Activiti调用，之后就成功跳转到目标节点</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>bpmn<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">HistoryService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">RuntimeService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>history<span class="token punctuation">.</span></span><span class="token class-name">HistoricTaskInstance</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">Command</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">CommandContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ProcessDefinitionUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">Execution</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>activiti<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">ProcessInstance</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 撤回任务
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskRecallCmd</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> taskId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TaskRecallCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskId <span class="token operator">=</span> taskId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 获取历史服务</span>
        <span class="token class-name">HistoryService</span> historyService <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHistoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据当前任务id查询历史任务</span>
        <span class="token class-name">HistoricTaskInstance</span> historicTaskInstance <span class="token operator">=</span>
            historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 进行一系列任务和流程校验</span>
        <span class="token function">basicCheck</span><span class="token punctuation">(</span>commandContext<span class="token punctuation">,</span> historicTaskInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取流程模型</span>
        <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> <span class="token class-name">ProcessDefinitionUtil</span><span class="token punctuation">.</span><span class="token function">getBpmnModel</span><span class="token punctuation">(</span>historicTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowElement</span> flowElement <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>historicTaskInstance<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nextElementIdList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserTask</span><span class="token punctuation">&gt;</span></span> nextUserTaskList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取后续节点信息</span>
        <span class="token function">getNextElementInfo</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">,</span> flowElement<span class="token punctuation">,</span> nextElementIdList<span class="token punctuation">,</span> nextUserTaskList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再校验是否后续节点任务是否已经办理完成</span>
        <span class="token function">existNextFinishedTaskCheck</span><span class="token punctuation">(</span>commandContext<span class="token punctuation">,</span> historicTaskInstance<span class="token punctuation">,</span> nextUserTaskList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 流程相关数据准备</span>
        <span class="token class-name">DynamicStateManager</span> dynamicStateManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicStateManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取可撤回的节点列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> recallElementIdList <span class="token operator">=</span>
            <span class="token function">getRecallElementIdList</span><span class="token punctuation">(</span>commandContext<span class="token punctuation">,</span> historicTaskInstance<span class="token punctuation">,</span> nextElementIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionEntity</span><span class="token punctuation">&gt;</span></span> executions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> activityId <span class="token operator">:</span> recallElementIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 查询后续节点对应的执行实例</span>
            <span class="token class-name">ExecutionEntity</span> execution <span class="token operator">=</span> dynamicStateManager
                <span class="token punctuation">.</span><span class="token function">resolveActiveExecution</span><span class="token punctuation">(</span>historicTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityId<span class="token punctuation">,</span> commandContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            executions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>execution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 执行撤回操作</span>
        dynamicStateManager<span class="token punctuation">.</span><span class="token function">moveExecutionState</span><span class="token punctuation">(</span>executions<span class="token punctuation">,</span> historicTaskInstance<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> commandContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 任务校验
     * 
     * @param commandContext
     * @param taskInstance
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">basicCheck</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">,</span> <span class="token class-name">HistoricTaskInstance</span> taskInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;任务不存在&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskInstance<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;任务正在执行,不需要回退&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断当前流程实例是否已经结束</span>
        <span class="token class-name">RuntimeService</span> runtimeService <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>taskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>processInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;该流程已经完成，无法进行任务回退。&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取后续节点信息
     * 
     * @param bpmnModel
     *            流程模型
     * @param currentFlowElement
     *            当前节点
     * @param nextElementIdList
     *            后续节点Id列表
     * @param nextUserTaskList
     *            后续用户任务节点列表
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getNextElementInfo</span><span class="token punctuation">(</span><span class="token class-name">BpmnModel</span> bpmnModel<span class="token punctuation">,</span> <span class="token class-name">FlowElement</span> currentFlowElement<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nextElementIdList<span class="token punctuation">,</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserTask</span><span class="token punctuation">&gt;</span></span> nextUserTaskList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查询当前节点所有流出顺序流</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> outgoingFlows <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlowNode</span><span class="token punctuation">)</span>currentFlowElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOutgoingFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SequenceFlow</span> flow <span class="token operator">:</span> outgoingFlows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 后续节点</span>
            <span class="token class-name">FlowElement</span> targetFlowElement <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span><span class="token function">getTargetRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            nextElementIdList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetFlowElement<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetFlowElement <span class="token keyword">instanceof</span> <span class="token class-name">UserTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextUserTaskList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserTask</span><span class="token punctuation">)</span>targetFlowElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>targetFlowElement <span class="token keyword">instanceof</span> <span class="token class-name">Gateway</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Gateway</span> gateway <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Gateway</span><span class="token punctuation">)</span>targetFlowElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 网关节点执行递归操作</span>
                <span class="token function">getNextElementInfo</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">,</span> gateway<span class="token punctuation">,</span> nextElementIdList<span class="token punctuation">,</span> nextUserTaskList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 其它类型节点暂未实现</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 校验是否后续节点任务是否已经办理完成
     * 
     * @param commandContext
     *            上下文CommandContext
     * @param currentTaskInstance
     *            当前任务实例
     * @param nextUserTaskList
     *            后续用户
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">existNextFinishedTaskCheck</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">,</span> <span class="token class-name">HistoricTaskInstance</span> currentTaskInstance<span class="token punctuation">,</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserTask</span><span class="token punctuation">&gt;</span></span> nextUserTaskList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricTaskInstance</span><span class="token punctuation">&gt;</span></span> hisTaskList <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHistoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>currentTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">taskCompletedAfter</span><span class="token punctuation">(</span>currentTaskInstance<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nextUserTaskIdList <span class="token operator">=</span> nextUserTaskList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserTask</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hisTaskList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hisTaskList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextUserTaskIdList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;存在已完成下一节点任务&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取可撤回的节点列表
     * 
     * @param commandContext
     *            上下文CommandContext
     * @param currentTaskInstance
     *            任务实例
     * @param nextElementIdList
     *            后续节点列表
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRecallElementIdList</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">,</span> <span class="token class-name">HistoricTaskInstance</span> currentTaskInstance<span class="token punctuation">,</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nextElementIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> recallElementIdList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Execution</span><span class="token punctuation">&gt;</span></span> executions <span class="token operator">=</span>
            commandContext<span class="token punctuation">.</span><span class="token function">getProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createExecutionQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>currentTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onlyChildExecutions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextElementIdList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    recallElementIdList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> recallElementIdList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div><h3 id="_7、任务撤销-收回实现"><a href="#_7、任务撤销-收回实现" class="header-anchor">#</a> 7、任务撤销/收回实现</h3> <p>任务撤销（或者是收回）的场景是：</p> <ul><li>只能由流程发起人操作</li> <li>清楚审批记录</li> <li>恢复到流程发起时的状态</li></ul> <p>代码核心逻辑如下：</p> <p>1、自定义CMD继承启动流程命令StartProcessInstanceCmd</p> <p>2、判断当前是否有流程实例ID，如果没有则正常启动，如果有则代表是撤销场景，则走自定义实现</p> <p>3、在自定义实现中去启动流程，初始化流程实例属性等</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>processInstanceHelper <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getProcessEngineConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProcessInstanceHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNoneBlank</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    processInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAndStartProcessInstance</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">,</span> processInstanceId<span class="token punctuation">,</span> businessKey<span class="token punctuation">,</span>
                                                         processInstanceName<span class="token punctuation">,</span> variables<span class="token punctuation">,</span> transientVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    processInstance <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createAndStartProcessInstance</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">,</span> businessKey<span class="token punctuation">,</span> processInstanceName<span class="token punctuation">,</span>
                                                          variables<span class="token punctuation">,</span> transientVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 创建流程实例</span>
<span class="token class-name">String</span> initiatorVariableName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>initialFlowElement <span class="token keyword">instanceof</span> <span class="token class-name">StartEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initiatorVariableName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StartEvent</span><span class="token punctuation">)</span>initialFlowElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInitiator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用自定义Execution实体管理器创建流程实例</span>
<span class="token class-name">ExecutionEntity</span> processInstance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CustomExecutionEntityManager</span><span class="token punctuation">)</span>commandContext<span class="token punctuation">.</span><span class="token function">getExecutionEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">createProcessInstanceExecution</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">,</span> processInstanceId<span class="token punctuation">,</span> businessKey<span class="token punctuation">,</span>
                                    processDefinition<span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initiatorVariableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241216200954298.png" alt="image-20241216200954298"></p> <h3 id="_7、代码创建流程模型"><a href="#_7、代码创建流程模型" class="header-anchor">#</a> 7、代码创建流程模型</h3> <h3 id="_8、会签加签"><a href="#_8、会签加签" class="header-anchor">#</a> 8、会签加签</h3> <p>业务场景： 审核节点临时增加一个或者多个共同审批人，同时审批结束后，当前节点才算是通过</p> <p>代码实现：</p> <p>1、新建加签命令AddMultiInstanceUserTaskCmd继承Command</p> <p>2、任务需要设置为多任务实例</p> <p>3、获取当前流程实例，为加签的并行会签创建子执行实例，同时去设置加签任务的局部变量</p> <p>4、最后把执行实例压入Operation中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//查询当前任务实例</span>
<span class="token class-name">TaskEntity</span> taskEntity <span class="token operator">=</span> taskEntityManager<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>taskEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span><span class="token string">&quot;id为&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taskId <span class="token operator">+</span> <span class="token string">&quot;的任务不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">ExecutionEntityManager</span> executionEntityManager <span class="token operator">=</span> commandContext<span class="token punctuation">.</span><span class="token function">getExecutionEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//查询当前任务实例所对应的执行实例</span>
<span class="token class-name">ExecutionEntity</span> executionEntity <span class="token operator">=</span> executionEntityManager<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>taskEntity<span class="token punctuation">.</span><span class="token function">getExecutionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//查询多实例的根执行实例</span>
<span class="token class-name">ExecutionEntity</span> miExecution <span class="token operator">=</span> executionEntityManager<span class="token punctuation">.</span><span class="token function">findFirstMultiInstanceRoot</span><span class="token punctuation">(</span>executionEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>miExecution <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span><span class="token string">&quot;节点 &quot;</span> <span class="token operator">+</span> taskEntity<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;不是多实例任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token comment">//查询多实例activiti:collection配置的表达式中的变量的值</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collectionValue <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span>miExecution<span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span>collectionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>collectionValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ActivitiException</span><span class="token punctuation">(</span><span class="token string">&quot;加签用户 &quot;</span> <span class="token operator">+</span> assignee <span class="token operator">+</span> <span class="token string">&quot;已经在审批名单中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//往变量中加入加签用户</span>
collectionValue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span><span class="token punctuation">;</span>
miExecution<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span>collectionKey<span class="token punctuation">,</span> collectionValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
<span class="token comment">//如果是并行多实例还需要做额外操作</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>multiInstanceLoopCharacteristics<span class="token punctuation">.</span><span class="token function">isSequential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//更新nrOfActiveInstances变量</span>
    <span class="token class-name">Integer</span> nrOfActiveInstances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> miExecution<span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token constant">NUMBER_OF_ACTIVE_INSTANCES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    miExecution<span class="token punctuation">.</span><span class="token function">setVariableLocal</span><span class="token punctuation">(</span><span class="token constant">NUMBER_OF_ACTIVE_INSTANCES</span><span class="token punctuation">,</span> nrOfActiveInstances <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建加签任务的执行实例</span>
    <span class="token class-name">ExecutionEntity</span> childExecution <span class="token operator">=</span> executionEntityManager<span class="token punctuation">.</span><span class="token function">createChildExecution</span><span class="token punctuation">(</span>miExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childExecution<span class="token punctuation">.</span><span class="token function">setCurrentFlowElement</span><span class="token punctuation">(</span>miActivityElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置加签任务执行实例的局部变量</span>
    <span class="token class-name">Map</span> executionVariables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executionVariables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>multiInstanceLoopCharacteristics<span class="token punctuation">.</span><span class="token function">getElementVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> assignee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ParallelMultiInstanceBehavior</span> miBehavior <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ParallelMultiInstanceBehavior</span><span class="token punctuation">)</span> miActivityElement<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executionVariables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>miBehavior<span class="token punctuation">.</span><span class="token function">getCollectionElementIndexVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>currentNumberOfInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childExecution<span class="token punctuation">.</span><span class="token function">setVariablesLocal</span><span class="token punctuation">(</span>executionVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//向operations中压入继续流程的操作类</span>
    commandContext<span class="token punctuation">.</span><span class="token function">getAgenda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">planContinueMultiInstanceOperation</span><span class="token punctuation">(</span>childExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><img src="https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20241216205123252.png" alt="image-20241216205123252"></p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Activiti" title="标签">#Activiti</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/be/activiti-03/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Activiti6-API详解</div></a> <a href="/be/92890/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">jar启动和IDE里启动Sprintboot的区别</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/be/activiti-03/" class="prev">Activiti6-API详解</a></span> <span class="next"><a href="/be/92890/">jar启动和IDE里启动Sprintboot的区别</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/be/activiti-03/"><div>
            Activiti6-API详解
            <!----></div></a> <span class="date">11-28</span></dt></dl><dl><dd>02</dd> <dt><a href="/be/activiti-02/"><div>
            SpringBoot集成Activiti和UI
            <!----></div></a> <span class="date">11-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/be/activiti-01/"><div>
            Activiti6-28张表关系梳理
            <!----></div></a> <span class="date">11-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2024
    <span>赵宇博 | <a href="https://github.com/zhaoyb-coder/" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e1cac8e6.js" defer></script><script src="/assets/js/2.1e4db32b.js" defer></script><script src="/assets/js/51.ad5c7c0a.js" defer></script>
  </body>
</html>
